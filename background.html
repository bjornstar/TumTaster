<html>
<script type="text/javascript">
  var playlist = new Array();
  var nowplaying = null;

	var defaultSettings = { 'shuffle': false, 'repeat': true, 'mp3player': 'flash', 'listBlack': ['beatles'], 'listWhite': ['bjorn', 'beck'], 'listSites': ['http://*.tumblr.com/*', 'http://bjornstar.com/*'] }; //initialize default values.
  if (localStorage["settings"] == undefined) {
    settings = defaultSettings;
  } else {
    settings = JSON.parse(localStorage["settings"]);
  }

  chrome.extension.onRequest.addListener( // Yes, this is ugly, I know. I'll fix it later.
    function(song, sender, sendResponse) {
			if (song == 'getSettings') {
				sendResponse({settings: localStorage["settings"]});
			} else {
				playlist[song.song_url] = song.post_url;
				var mySoundObject = soundManager.createSound({
					id: song.post_url,
					url: song.song_url,
					onloadfailed: function(){playnextsong(song.post_url)},
					onfinish: function(){playnextsong(song.post_url)}
				});
				sendResponse({});
			}
  });
  
  function playnextsong(previous_song) {
    var bad_idea = null;
    var first_song = null;
    var next_song = null;

    for (x in soundManager.sounds) {
      if (soundManager.sounds[x].sID != previous_song && bad_idea == previous_song && next_song == null) {
        next_song = soundManager.sounds[x].sID;
      }
      bad_idea = soundManager.sounds[x].sID;
      if (first_song == null) {
        first_song = soundManager.sounds[x].sID;
      }
    }

    if (settings["shuffle"]) {
      var s = Math.floor(Math.random()*soundManager.soundIDs.length+1);
      next_song = soundManager.soundIDs[s];
    }
    
    if (settings["repeat"] && bad_idea == previous_song) {
      next_song = first_song;
    }

    if (next_song != null) {
      var soundNext = soundManager.getSoundById(next_song);
      soundNext.play();
    }
  }
  
  function playrandomsong(previous_song) {
		var x = Math.floor(Math.random()*soundManager.soundIDs.length+1);
    var mySoundObject = soundManager.getSoundById(soundManager.soundIDs[x]);
    mySoundObject.play();
	}

  if (settings["mp3player"]=="flash") {
    var fileref=document.createElement('script');
    fileref.setAttribute("type","text/javascript");
    fileref.setAttribute("src", "soundmanager2.js");
    document.getElementsByTagName("head")[0].appendChild(fileref);
  }

</script>
<h1>ChromeTaster</h1>
</html>