<html>
<script type="text/javascript" src="soundmanager2.js"></script>
<script type="text/javascript">
  var playlist = new Array();
  var nowplaying = null;

  chrome.extension.onRequest.addListener( // Yes, this is ugly, I know. I'll fix it later.
    function(song, sender, sendResponse) {
			if (song == 'getSettings') {
				sendResponse({settings: localStorage["settings"]});
			} else {
				playlist[song.song_url] = song.post_url;
				var mySoundObject = soundManager.createSound({
					id: song.post_url,
					url: song.song_url,
					onloadfailed: function(){playnextsong(song.post_url)},
					onfinish: function(){playnextsong(song.post_url)}
				});
				sendResponse({});
			}
  });
  
  function playnextsong(previous_song) {
    var bad_idea = null;
    var first_song = null;
    var next_song = null;

    for (x in soundManager.sounds) {
      if (soundManager.sounds[x].sID != previous_song && bad_idea == previous_song && next_song == null) {
        next_song = soundManager.sounds[x].sID;
      }
      bad_idea = soundManager.sounds[x].sID;
      if (first_song == null) {
        first_song = soundManager.sounds[x].sID;
      }
    }

    if (localStorage["shuffle"]) {
      var s = Math.floor(Math.random()*soundManager.soundIDs.length+1);
      next_song = soundManager.soundIDs[s];
    }
    
    if (localStorage["repeat"] && bad_idea == previous_song) {
      next_song = first_song;
    }
    
    if (next_song != null) {
      var soundNext = soundManager.getSoundById(next_song);
      soundNext.play();
    }
  }
  
  function playrandomsong(previous_song) {
		var x = Math.floor(Math.random()*soundManager.soundIDs.length+1);
    var mySoundObject = soundManager.getSoundById(soundManager.soundIDs[x]);
    mySoundObject.play();
	}
		
</script>
<h1>ChromeTaster</h1>
</html>